<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
        <title>綁定</title>
    </head>
    <body>
        <div class="container">
            <p class="mail" style="text-align: left;">信箱：</p>
            <input type="text" id="email" placeholder="信箱">
            <p class="password"  style="text-align: left;">驗證碼：</p>
            <input type="text" id="code" placeholder="驗證碼"></br>
            <button type="button" id="send">寄送驗證碼</button>
            <button type="button" id="sure">確認</button>
            <p style="display: none;">userId:<span id="userId"></span></p>
            <p style="display: none;">displayName:<span id="displayName"></span></p>
            <p style="display: none;">pictureUrl:<span id="pictureUrl"></span></p>
            <p style="display: none;">statusMessage:<span id="statusMessage"></span></p>
        </div>    
    </body>
    <script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
    <script>
        liff.init(data => {
          // https://developers.line.biz/en/reference/liff/#initialize-liff-app
          // data.language == "zh-TW"
          // data.context.type = utou | room | group | none
          // data.context.utouId
          // data.context.roomId
          // data.context.groupId
          // data.context.userId
          // data.context.viewType = compact | tall | full
          liff.getProfile().then(profile => {
              document.getElementById('userId').innerHTML = profile.userId
              document.getElementById('displayName').innerHTML = profile.displayName
              document.getElementById('pictureUrl').innerHTML = profile.pictureUrl
              document.getElementById('statusMessage').innerHTML = profile.statusMessage
          })
          
        },
        err => {
          // LIFF initialization failed
          
        });

       document.getElementById('send').onclick = function()
        {
            var emailElement = document.getElementById('email')
            var email = emailElement.value
            var request = new XMLHttpRequest();
            // POST to httpbin which returns the POST data as JSON
            request.open('POST', 'https://induparkweb-stage.ddns.net:8068/api/CompanyUpload/SendUploadVERCodeEmail', /* async = */ false);

            var formData = new FormData();
            formData.append('UserId', email);

            request.send(formData);
            console.log(request.responseText);
            var callbackData = JSON.parse(request.responseText);
            var str = callbackData.description;
            if (str == "寄送Email成功"){
                alert("已寄出驗證碼");
            }
            else if (str == "使用者驗證碼程序錯誤。使用者帳號[UserId]不存在"){
                alert("信箱未註冊請重新輸入");
            }
            else if (str == "[UserId]為必填參數"){
                alert("請填入信箱");
            }
            else if (str == "使用者驗證碼程序錯誤。已寄送驗證碼，請稍後在試"){
                alert("已寄送驗證碼，請稍後在試");
            }
            else if (str == "使用者驗證碼程序錯誤。"){
                alert("使用者驗證碼程序錯誤。");
            }
        }

        

       document.getElementById('sure').onclick = function()
        {
            var emailElement = document.getElementById('email')
            var email = emailElement.value
            var codeElement = document.getElementById('code')
            var code = codeElement.value
            var userIdElement = document.getElementById('userId')
            var userId = userIdElement.value
            var request = new XMLHttpRequest();
            // POST to httpbin which returns the POST data as JSON
            request.open('POST', 'https://induparkweb-stage.ddns.net:8068/api/Line/SmartParkBindLineId', /* async = */ false);

            var formData = new FormData();
            formData.append('UserId', email);
            formData.append('LineId', userId);
            formData.append('Code', code);

            request.send(formData);
            console.log(request.response);
            var callbackData = JSON.parse(request.responseText);
            var str = callbackData.description;
            if (str == "綁定成功"){
                alert("綁定成功");
            }
            else if (str == "(發生錯誤)驗證碼驗證過程中錯誤--驗證碼錯誤"){
                alert("驗證碼錯誤");
            }
            else if (str == "(發生錯誤)LineId綁定過程中錯誤--"){
                alert("綁定錯誤請重試");
            }
            else if (str == "(發生錯誤)--"){
                alert("發生錯誤");
            }
            else if (str == "使用者驗證碼程序錯誤。"){
                alert("使用者驗證碼程序錯誤。");
            }
        }
    </script>
    <style>
        *{
        font-family:微軟正黑體;  
        }

        body{
        background-color: gainsboro;
        }

        #username, #password, h3, #fullname, #comfirm_password,#username2, #password2{
        width: 200px;
        height: 20px;
        margin: 10px;
        color: #df5334;
        }

        h5{
        margin: 20px;
        color: #a3a2a3;
        }

        h5:hover{
        color: black;
        }

        .container{
        margin: 50px;
        padding: 10px;
        width: 230px;
        height: 300px;
        background-color: white;
        border-radius: 5px;
        border-top: 10px solid #df5334;
        box-shadow: 0 0px 70px rgba(0, 0, 0, 0.1);
        
        /*定位對齊*/
        position:relative;   
        margin: auto;
        top: 100px;
        text-align:center;  
        }

        .system_name{
        /*定位對齊*/
        position:relative;   
        margin: auto;
        top: 100px;
        text-align:center; 
        }

        #send,#sure{
        color: white;  
        background: #df5334;
        width: 200px;
        height: 30px;
        margin: 10px;
        padding: 5px;
        border-radius: 5px;
        border: 0px;
        }

        .submit:hover{
        background: #db6937;
        }

        #container2{
        visibility: hidden;   /*剛開始消失*/
        height: 350px;
        }


        #copyright{
        text-align: center;
        color: #a3a2a3;
        margin: -200px 0px 0px 0px;
        font-size: 14px;
        }

        input{
        padding: 5px;
        border: none; 
        border:solid 1px #ccc;
        border-radius: 5px;
        }
    </style>
</html>